# MH Project Ordering System Notes

## Codebase Understanding (Current)

- Main playable scene: `scenes/environment/clinic_map.tscn`
- Main scene script: `scenes/environment/clinic_map.gd`
- UI root (inventory + orders): `scenes/environment/inventory_ui.tscn`
- UI logic: `scenes/environment/inventory_ui.gd`
- Order card prefab: `order/ordercard.tscn`
- Order card logic: `order/ordercard.gd`
- Submit station prefab: `GUI/interactable/box/submit.tscn`
- Submit station logic: `GUI/interactable/box/submit.gd`
- Item enum: `order/item_type.gd` (`ItemTypes.ItemType`)

### Current Gameplay Flow

1. Loot boxes emit `item_obtained(item_type)`.
2. `clinic_map.gd` forwards that item into `inventory_ui.add_item(item_type)`.
3. Submit station emits `submit_requested` each interact press (no cooldown).
4. `clinic_map.gd` listens for `submit_requested` and calls `inventory_ui.submit_top_item_to_orders()`.
5. Inventory consumes the top item every submit press.
6. That item is applied to the first active order that currently expects it.

## Changes Made In This Iteration

## Wave / Session Layer (new)

- Added session timer (from `Global.game_time_limit`).
- Added per-wave target score:
  - starts at `Global.wave_target_base_score`
  - next wave target multiplies by `Global.wave_target_growth_multiplier`
- Added HUD labels:
  - current wave target score
  - remaining session timer
- When score reaches wave target:
  - buff popup appears with 3 choices
  - choose one to continue to next wave
- Next wave difficulty:
  - `Global.order_length_min` and `Global.order_length_max` both increase by 1 (clamped to 6)

### Buff choices

- `more_time`: increases `Global.order_time_limit`
- `faster_boxes`: decreases `Global.box_respawn_time`
- `faster_player`: increases `Global.player_move_speed`

## Game End Screen (new)

- When session timer reaches 0:
  - game ends for ordering loop
  - game-over popup shows:
    - patients cured
    - patient satisfaction (derived from average time used)
    - final score

## 1) Multi-order generation and horizontal layout

- Added `OrdersHBox` in `scenes/environment/inventory_ui.tscn`.
- `inventory_ui.gd` now dynamically spawns `OrderCard` instances into `OrdersHBox`.
- Orders are arranged horizontally by `HBoxContainer`.

### Order spawn rules implemented

- Spawn interval: every `10` seconds (`order_spawn_interval` export).
- Max active orders: `3` (`max_active_orders` export).
- Initial order is spawned on `_ready()` (so system starts with an order).
- Random order length configurable (`order_length_min`, `order_length_max`) and clamped to max slot count (6).

## 2) Randomized required items per order

- `inventory_ui.gd` added `allowed_order_items` export array.
- Orders are generated by randomly picking from `allowed_order_items`.
- Default includes all pills + all injections.

## 3) Per-order countdown + timeout removal

- Existing `OrderCard` progress bar countdown is kept and used.
- On timeout, order emits `timed_out`, manager removes and frees that card.

## 4) Correct-order submission behavior

- `OrderCard` gained:
  - `is_active()`
  - `peek_expected_item()`
- `inventory_ui.gd` submission logic:
  - Takes top inventory item.
  - Finds first active order where `peek_expected_item()` equals item.
  - Submits only to that order (so only matching order progresses/lightens).
  - Consumes top inventory item regardless (one item per submit interaction).

## 5) Expanded order icon support

- `order/ordercard.gd` now supports icons for:
  - red/blue/green/purple pill
  - red/blue/green/purple injection
- `inventory_ui.gd` assigns these textures to every newly spawned order card.

## 6) Submit station behavior

- `submit.gd` now emits `submit_requested`.
- Cooldown/timer/progress-bar logic removed from script.
- `submit.tscn` has no RespawnBar node.
- Interact is repeatable.

## 7) Clinic map integration updates

- `clinic_map.gd` now:
  - Connects submit station signal to inventory order submit.
  - Uses `inventory_ui.spawn_debug_order(...)` on `test` input.
- Removed static hardcoded `Ordercard` instance from `clinic_map.tscn`.

## 8) Safety adjustments

- `order/ordercard.gd` clamps required sequence to slot capacity.
- Visual update loop also clamps to slot count.

## Tunables To Edit Quickly

In `global.gd`:

- `max_active_orders` (default 3)
- `order_spawn_interval` (default 10.0)
- `order_time_limit` (default 15.0)
- `order_length_min` / `order_length_max`
- `allowed_order_items`
- `debug_order_sequence`
- `debug_time_limit`

## Important Notes / Assumptions

- Submit currently consumes top inventory item even when no order matches.
- Matching order selection is "first active matching order" in `active_orders` order.
- `OrderCard.submit_item()` still has legacy fail behavior for wrong item, but manager only calls it when expected item matches.
- No runtime playtest was executed in this environment; behavior is implemented from script/scene edits.

## Latest Updates (Current Source of Truth)

## Globalized Tunables + Modifier System

File: `global.gd`

- Most gameplay tuning is centralized here.
- Includes:
  - inventory sizing
  - order generation/timing
  - wave target/timer config
  - player speed/debug upgrade values
  - score value
  - box respawn time (`box_respawn_time`)
- Runtime modifier API added:
  - `set_modifiers_enabled(enabled)`
  - `reset_modifiable_values()`
  - `modify_value(key, operation, amount)`
  - `get_modifiable_keys()`
- Operation support: add, minus/subtract, multiply, divide
- Central min/max clamp table: `_MODIFIABLE_LIMITS`

## Wave Popup + Game Over Popup

Files:
- `scenes/ui/wave_popup.tscn`
- `scenes/ui/wave_popup.gd`
- `scenes/ui/game_over_popup.tscn`
- `scenes/ui/game_over_popup.gd`

Wave popup now has 4 buffs:
- `more_time`
- `faster_boxes`
- `faster_player`
- `inventory_up` (increases unlocked inventory by exactly +1)

Game over popup shows:
- patients cured
- patient satisfaction
- final score

## Inventory UI Wave Flow

File: `scenes/environment/inventory_ui.gd`

- HUD labels managed here:
  - `ScoreLabel`
  - `WaveTargetLabel`
  - `GameTimerLabel`
- Session flow:
  - countdown from `Global.game_time_limit`
  - when score reaches wave target -> show wave popup
  - after buff selection -> next wave, target increases by multiplier
  - order length min/max increase each wave (clamped)
  - when timer ends -> game over popup

## Score Formula

File: `scenes/environment/inventory_ui.gd` (`_on_order_completed`)

- `added_score = 100 * time_left * item_count`
- Added to `Global.score`
- Prints:
  - formula breakdown
  - score added
  - total score

## Satisfaction Formula

Files:
- `scenes/environment/inventory_ui.gd`
- `scenes/ui/game_over_popup.gd`

Per completed order:
- `time_used_ratio = 1 - (time_left / duration)`

At game end:
- `average_time_used_ratio = total_time_used_ratio / cured_patients` (or 1.0 if none)
- UI shows:
  - `time used %`
  - `satisfaction % = 100 - time used %`

## Submit Stations

File: `scenes/environment/clinic_map.gd`

- Auto-connects all direct child nodes that have `submit_requested` signal.
- This supports multiple submit boxes (`submit`, `submit2`, etc.) without manual wiring.

## Loot Box Respawn Buff Hook

File: `GUI/interactable/box/finalbox.gd`

- Box respawn timing now reads `Global.box_respawn_time`.
- This makes `faster_boxes` buff affect all loot boxes.

## Player Input / Buff Interaction Fixes

File: `scenes/entities/player/player.gd`

- Movement speed now refreshes from `Global.player_move_speed` each physics frame.
  - Speed buffs apply immediately in-run.
- Debug inventory upgrade was moved off generic mouse click to `U` key
  - prevents UI button clicks from accidentally giving extra inventory slots.

## OrderCard Visual/Timer Enhancements

File: `order/ordercard.gd`

- Time bar uses real-time values (`max_value = duration`, `value = time_left`).
- Time bar color thresholds:
  - normal
  - warning
  - danger/red (<= 50%)
- Face by order length logic:
  - 1-2: normal
  - 3-4: sad
  - 5-6: very sad
- Safe fallback if `normal.png`, `sad.png`, `very_sad.png` not present.
