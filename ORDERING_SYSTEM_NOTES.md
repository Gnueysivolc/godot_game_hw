# MH Project Ordering System Notes

## Codebase Understanding (Current)

- Main playable scene: `scenes/environment/clinic_map.tscn`
- Main scene script: `scenes/environment/clinic_map.gd`
- UI root (inventory + orders): `scenes/environment/inventory_ui.tscn`
- UI logic: `scenes/environment/inventory_ui.gd`
- Order card prefab: `order/ordercard.tscn`
- Order card logic: `order/ordercard.gd`
- Submit station prefab: `GUI/interactable/box/submit.tscn`
- Submit station logic: `GUI/interactable/box/submit.gd`
- Item enum: `order/item_type.gd` (`ItemTypes.ItemType`)

### Current Gameplay Flow

1. Loot boxes emit `item_obtained(item_type)`.
2. `clinic_map.gd` forwards that item into `inventory_ui.add_item(item_type)`.
3. Submit station emits `submit_requested` each interact press (no cooldown).
4. `clinic_map.gd` listens for `submit_requested` and calls `inventory_ui.submit_top_item_to_orders()`.
5. Inventory consumes the top item every submit press.
6. That item is applied to the first active order that currently expects it.

## Changes Made In This Iteration

## 1) Multi-order generation and horizontal layout

- Added `OrdersHBox` in `scenes/environment/inventory_ui.tscn`.
- `inventory_ui.gd` now dynamically spawns `OrderCard` instances into `OrdersHBox`.
- Orders are arranged horizontally by `HBoxContainer`.

### Order spawn rules implemented

- Spawn interval: every `10` seconds (`order_spawn_interval` export).
- Max active orders: `3` (`max_active_orders` export).
- Initial order is spawned on `_ready()` (so system starts with an order).
- Random order length configurable (`order_length_min`, `order_length_max`) and clamped to max slot count (6).

## 2) Randomized required items per order

- `inventory_ui.gd` added `allowed_order_items` export array.
- Orders are generated by randomly picking from `allowed_order_items`.
- Default includes all pills + all injections.

## 3) Per-order countdown + timeout removal

- Existing `OrderCard` progress bar countdown is kept and used.
- On timeout, order emits `timed_out`, manager removes and frees that card.

## 4) Correct-order submission behavior

- `OrderCard` gained:
  - `is_active()`
  - `peek_expected_item()`
- `inventory_ui.gd` submission logic:
  - Takes top inventory item.
  - Finds first active order where `peek_expected_item()` equals item.
  - Submits only to that order (so only matching order progresses/lightens).
  - Consumes top inventory item regardless (one item per submit interaction).

## 5) Expanded order icon support

- `order/ordercard.gd` now supports icons for:
  - red/blue/green/purple pill
  - red/blue/green/purple injection
- `inventory_ui.gd` assigns these textures to every newly spawned order card.

## 6) Submit station behavior

- `submit.gd` now emits `submit_requested`.
- Cooldown/timer/progress-bar logic removed from script.
- `submit.tscn` has no RespawnBar node.
- Interact is repeatable.

## 7) Clinic map integration updates

- `clinic_map.gd` now:
  - Connects submit station signal to inventory order submit.
  - Uses `inventory_ui.spawn_debug_order(...)` on `test` input.
- Removed static hardcoded `Ordercard` instance from `clinic_map.tscn`.

## 8) Safety adjustments

- `order/ordercard.gd` clamps required sequence to slot capacity.
- Visual update loop also clamps to slot count.

## Tunables To Edit Quickly

In `global.gd`:

- `max_active_orders` (default 3)
- `order_spawn_interval` (default 10.0)
- `order_time_limit` (default 15.0)
- `order_length_min` / `order_length_max`
- `allowed_order_items`
- `debug_order_sequence`
- `debug_time_limit`

## Important Notes / Assumptions

- Submit currently consumes top inventory item even when no order matches.
- Matching order selection is "first active matching order" in `active_orders` order.
- `OrderCard.submit_item()` still has legacy fail behavior for wrong item, but manager only calls it when expected item matches.
- No runtime playtest was executed in this environment; behavior is implemented from script/scene edits.
